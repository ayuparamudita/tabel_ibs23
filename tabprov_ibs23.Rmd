---
title: "Draf Tabel STPIM 2023"
author: "Ayu Paramudita"
output: 
  html_document:
    toc: yes
    toc_float: true
    code_folding: hide
css: styles.css
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

## Pendahuluan

Berikut ini adalah kode untuk membuat tabulasi Rantab STPIM 2023. Jumlah tabel yang akan dihasilkan adalah sebanyak 12 tabel.

```{r package}
library(readxl)
library(dplyr)
library(scales)
library(knitr)
library(openxlsx)
```

## Input Data

```{r input data}
#stpim23    = read_excel("SKIM-STPIM.xlsx")
stpim23    = read_excel("STPIM23.xlsx")
jumlah     = read_excel("Jumlah Populasi STPIM dan SKIM 2023.xlsx")
masterprov = read_excel("Master_Provinsi.xlsx")

## UBAH TIPE DATA AGAR BISA DIMATCH
masterprov <- masterprov |>
  mutate(Kode_Prov = as.character(Kode_Prov))
```

## Tabel 1.2 Jumlah Perusahaan dan Banyaknya Pekerja menurut Provinsi, 2023

::: callout-note
Jumlah perusahaan diambil dari file excel Jumlah Populasi STPIM dan SKIM 2023 yang telah ditetapkan. 
Banyaknya pekerja diambil dari *r206a Jumlah pekerja termasuk pekerja asing*.
:::

```{r tabel 1.2}
## KOLOM 2
kolom2_tabel1_2 = jumlah |>
  mutate(Provinsi = if_else(Provinsi == "Grand Total", "Indonesia", Provinsi)) |>
  select(Provinsi = Provinsi, Perusahaan = `Grand Total`)
  
## KOLOM 3
kolom3_tabel1_2 <- stpim23 |>
  group_by(prov) |>                 
  summarise(Tenaga_Kerja = sum(r206a * weight, na.rm = TRUE)) |>
  rename(Provinsi = prov)

## GABUNG
tabel1_2_prov <- kolom2_tabel1_2 |>
  left_join(kolom3_tabel1_2, by = "Provinsi") |>
  mutate(
    Tenaga_Kerja = if_else(is.na(Tenaga_Kerja), sum(Tenaga_Kerja, na.rm = TRUE), Tenaga_Kerja)
  )

# SEPARATOR RIBUAN
tabel1_2_prov <- tabel1_2_prov |> 
  mutate(
    across(
      .cols = c(Perusahaan, Tenaga_Kerja), 
      .fns = ~ format(round(., 0), big.mark = ".", decimal.mark = ",", scientific = FALSE)
    )
  )

## MATCH KODE & NAMA PROV
tabel1_2_prov <- tabel1_2_prov |>
  left_join(masterprov, by = c("Provinsi" = "Kode_Prov")) |>      # MATCH NAMA DAN KODE PROV
  mutate(
    Nama_Prov = if_else(is.na(Nama_Prov), Provinsi, Nama_Prov)    
  ) |>
  select(-1) |>                                                   # REORDER POSISI VAR
  select(ncol(tabel1_2_prov), everything()) |>
  rename(Provinsi = Nama_Prov)

## TABULASI
kable(tabel1_2_prov, align = "r")

```

## Tabel 2.2 Jumlah Perusahaan dan Jenis Tenaga Kerja menurut Provinsi, 2023

::: callout-note
Jumlah perusahaan diambil dari file excel Jumlah Populasi STPIM dan SKIM 2023 yang telah ditetapkan. 
Tenaga kerja menurut klasifikasinya diambil dari rincian masing-masing sesuai klasifikasi tenaga kerja.
:::

```{r tabel 2.2}
## KOLOM 3-10
kolom3_10_tabel2_2 <- stpim23 |>
  group_by(prov) |>                 
  summarise(Tenaga_Kerja_L        = sum(r206b_1 * weight, na.rm = TRUE),        # KOLOM 3
            Tenaga_Kerja_P        = sum(r206b_2 * weight, na.rm = TRUE),        # KOLOM 4
            Tenaga_Kerja_sumLP    = Tenaga_Kerja_L + Tenaga_Kerja_P,            # KOLOM 5
            Tenaga_Kerja_Prod     = sum(r206c_1 * weight, na.rm = TRUE),        # KOLOM 6
            Tenaga_Kerja_Lain     = sum(r206c_2 * weight, na.rm = TRUE),        # KOLOM 7
            Tenaga_Kerja_sumPrdLn = Tenaga_Kerja_Prod + Tenaga_Kerja_Lain,      # KOLOM 8
            Tenaga_Kerja_Asi      = sum(r206d * weight, na.rm = TRUE),          # KOLOM 9
            Tenaga_Kerja_Total    = sum(r206a * weight, na.rm = TRUE)) |>       # KOLOM 10
  rename(Provinsi = prov)

## GABUNG KOLOM 2-10
tabel2_2_prov <- kolom2_tabel1_2 |>
  left_join(kolom3_10_tabel2_2, by = "Provinsi") |>
  mutate(
    across(                                                      # SUM TOTAL COL Tenaga_Kerja_.
      .cols = starts_with("Tenaga_Kerja"), 
      .fns = ~ if_else(is.na(.), sum(., na.rm = TRUE), .)
    )
  ) |>
  mutate(Provinsi = if_else(Provinsi == "Total", "Indonesia", Provinsi))

# SEPARATOR RIBUAN
tabel2_2_prov <- tabel2_2_prov %>%
  mutate(
    across(
      .cols = c(Perusahaan, Tenaga_Kerja_L, Tenaga_Kerja_P, Tenaga_Kerja_sumLP, 
                Tenaga_Kerja_Prod, Tenaga_Kerja_Lain, Tenaga_Kerja_sumPrdLn, 
                Tenaga_Kerja_Asi, Tenaga_Kerja_Total),
      .fns = ~ format(round(., 0), big.mark = ".", decimal.mark = ",", scientific = FALSE)
    )
  )


## MATCH KODE & NAMA PROV
tabel2_2_prov <- tabel2_2_prov |>
  left_join(masterprov, by = c("Provinsi" = "Kode_Prov")) |>      # MATCH NAMA DAN KODE PROV
  mutate(
    Nama_Prov = if_else(is.na(Nama_Prov), Provinsi, Nama_Prov)    
  ) |>
  select(-1) |>                                                   # REORDER POSISI VAR
  select(ncol(tabel2_2_prov), everything()) |>
  rename(Provinsi = Nama_Prov)

## TABULASI
kable(tabel2_2_prov, align = "r")

```

## Tabel 3.2 Pengeluaran untuk Pekerja menurut Provinsi dan Jenis Pengeluaran, 2023

::: callout-note
Upah dan pengeluaran untuk pekerja diambil dari rincian masing-masing sesuai klasifikasinya. 
:::

```{r tabel 3.2}
## KOLOM 2-8 PENGELUARAN PEKERJA
kolom2_8_tabel3_2 <- stpim23 |>
  group_by(prov) |>                 
  summarise(
    Upah_Prod          = sum(r301a_1 * weight, na.rm = TRUE),
    PengPekLain_Prod   = sum(r301a_2 * weight, na.rm = TRUE),
    TotalPengPek_Prod  = Upah_Prod + PengPekLain_Prod,
    Upah_Lain          = sum(r301b_3 * weight, na.rm = TRUE),
    PengPekLain_Lain   = sum(r301b_4 * weight, na.rm = TRUE),
    TotalPengPek_Lain  = Upah_Lain + PengPekLain_Lain,
    TotalPengPek       = sum(r301c * weight, na.rm = TRUE)
  ) |>
  rename(Provinsi = prov)

# BUAT BARIS TOTAL BARU
total_row_tabel3_2 <- data.frame(
  Provinsi = "Indonesia",
  Upah_Prod           = sum(kolom2_8_tabel3_2$Upah_Prod, na.rm = TRUE),
  PengPekLain_Prod    = sum(kolom2_8_tabel3_2$PengPekLain_Prod, na.rm = TRUE),
  TotalPengPek_Prod   = sum(kolom2_8_tabel3_2$TotalPengPek_Prod, na.rm = TRUE),
  Upah_Lain           = sum(kolom2_8_tabel3_2$Upah_Lain, na.rm = TRUE),
  PengPekLain_Lain    = sum(kolom2_8_tabel3_2$PengPekLain_Lain, na.rm = TRUE),
  TotalPengPek_Lain   = sum(kolom2_8_tabel3_2$TotalPengPek_Lain, na.rm = TRUE),
  TotalPengPek        = sum(kolom2_8_tabel3_2$TotalPengPek, na.rm = TRUE))

# TAMBAHKAN BARIS BARU KE TABEL 3.2
tabel3_2_prov = rbind(kolom2_8_tabel3_2, total_row_tabel3_2)

# SEPARATOR RIBUAN
tabel3_2_prov <- tabel3_2_prov |> 
  mutate(
    across(
      .cols = c(Upah_Prod, PengPekLain_Prod, TotalPengPek_Prod, 
                Upah_Lain, PengPekLain_Lain, TotalPengPek_Lain, 
                TotalPengPek), 
      .fns = ~ format(round(., 0), big.mark = ".", decimal.mark = ",", scientific = FALSE)
      )
  )

## MATCH KODE & NAMA PROV
tabel3_2_prov <- tabel3_2_prov |>
  left_join(masterprov, by = c("Provinsi" = "Kode_Prov")) |>      # MATCH NAMA DAN KODE PROV
  mutate(
    Nama_Prov = if_else(is.na(Nama_Prov), Provinsi, Nama_Prov)    
  ) |>
  select(-1) |>                                                   # REORDER POSISI VAR
  select(ncol(tabel3_2_prov), everything()) |>
  rename(Provinsi = Nama_Prov)

## TABULASI
kable(tabel3_2_prov, align = "r")

```

## Tabel 4.2 Biaya Input menurut Provinsi, 2023

::: callout-note
**Bahan baku dan penolong** diambil dari variabel r501k5_sum yang sudah disesuaikan antara STPIM (dipisah) dan SKIM (digabung).
**Bahan bakar, listrik, dan gas** diambil dari variabel *r303a Nilai bahan bakar dan pelumas* dan *r304c Pengeluaran listrik*.
**Sewa gedung, mesin, dan alat** diambil dari variabel *r305a Pengeluaran sewa/kontrak gedung, mesin, serta alat*.
**Jasa industri** yang dibayarkan diambil dari variabel *r311 Nilai jasa industri yang dibayar ke pihak lain*.
**Pengeluaran lain** diambil dari variabel *r312 Nilai pengeluaran air* dan *r313 Pengeluaran lainnya*.
:::

```{r tabel 4.2}
## KOLOM 2-7 NILAI INPUT
kolom2_7_tabel4_2 <- stpim23 |>
  group_by(prov) |>                 
  summarise(
    Bahan_BakuPnl    = sum(r501k5_sum * weight, na.rm = TRUE),
    Bakar_Listrik    = sum((r303a + r304c) * weight, na.rm = TRUE),
    Sewa_Gd          = sum(r305a * weight, na.rm = TRUE),
    Jasa_Input       = sum(r311 * weight, na.rm = TRUE),
    Peng_Lain        = sum((r312 + r313) * weight, na.rm = TRUE),
    Total_Input      = Bahan_BakuPnl + Bakar_Listrik + Sewa_Gd + Jasa_Input + Peng_Lain) |>
   rename(Provinsi = prov)

# BUAT BARIS TOTAL BARU
total_row_tabel4_2 <- data.frame(
  Provinsi = "Indonesia",
  Bahan_BakuPnl      = sum(kolom2_7_tabel4_2$Bahan_BakuPnl, na.rm = TRUE),
  Bakar_Listrik      = sum(kolom2_7_tabel4_2$Bakar_Listrik, na.rm = TRUE),
  Sewa_Gd            = sum(kolom2_7_tabel4_2$Sewa_Gd, na.rm = TRUE),
  Jasa_Input         = sum(kolom2_7_tabel4_2$Jasa_Input, na.rm = TRUE),
  Peng_Lain          = sum(kolom2_7_tabel4_2$Peng_Lain, na.rm = TRUE),
  Total_Input        = sum(kolom2_7_tabel4_2$Total_Input, na.rm = TRUE))
  
# TAMBAHKAN BARIS BARU KE TABEL 4.2
tabel4_2_prov = rbind(kolom2_7_tabel4_2, total_row_tabel4_2)

# SEPARATOR RIBUAN
tabel4_2_prov <- tabel4_2_prov |> 
  mutate(
    across(
      .cols = c(Bahan_BakuPnl, Bakar_Listrik, Sewa_Gd, 
                Jasa_Input, Peng_Lain, Total_Input), 
      .fns = ~ format(round(., 0), big.mark = ".", decimal.mark = ",", scientific = FALSE)
    )
  )

## MATCH KODE & NAMA PROV
tabel4_2_prov <- tabel4_2_prov |>
  left_join(masterprov, by = c("Provinsi" = "Kode_Prov")) |>      # MATCH NAMA DAN KODE PROV
  mutate(
    Nama_Prov = if_else(is.na(Nama_Prov), Provinsi, Nama_Prov)    
  ) |>
  select(-1) |>                                                   # REORDER POSISI VAR
  select(ncol(tabel4_2_prov), everything()) |>
  rename(Provinsi = Nama_Prov)

## TABULASI
kable(tabel4_2_prov, align = "r")

```

## Tabel 5.2 Nilai Output menurut Provinsi, 2023

::: callout-note
**Barang produksi** diambil dari variabel r503k6_sum yang telah disesuaikan antara STPIM dan SKIM.
**Listrik dijual** diambil dari variabel *r404d Tenaga listrik dijual*.
**Jasa industri diterima dari pihak lain** diambil dari variabel *r403a Nilai pendapatan jasa industri*.
**Selisih nilai stok barang setengah jadi** diambil dari variabel *r406b Nilai stok barang produksi setengah jadi kondisi 31 Des* dikurangi *r406a Nilai stok barang produksi setengah jadi kondisi 1 Jan*.
**Penerimaan lainnya** diambil dari variabel *r404a Nilai untung/rugi penjualan barang yang sama*, *r404b Penjualan kekayaan intelektual*, *r404c Nilai jasa tidak berkaitan dengan produksi*, *r404f Pendapatan lainnya*.
:::

```{r tabel 5.2}
## KOLOM 2-7 NILAI OUTPUT
kolom2_7_tabel5_2 <- stpim23 |>
  group_by(prov) |>                 
  summarise(
    Barang_Prod    = sum(r503k6_sum * weight, na.rm = TRUE),
    Listrik_Prod   = sum(r404d * weight, na.rm = TRUE),
    Jasa_Prod      = sum(r403a * weight, na.rm = TRUE),
    Selisih_Stok   = sum((r406b - r406a) * weight, na.rm = TRUE),
    Output_Lain    = sum((r404a + r404b + r404c + r404f) * weight, na.rm = TRUE), 
    Total_Output   = Barang_Prod + Listrik_Prod + Jasa_Prod + Selisih_Stok +  Output_Lain ) |>
  rename(Provinsi = prov)

# BUAT BARIS TOTAL BARU
total_row_tabel5_2 <- data.frame(
  Provinsi = "Indonesia",
  Barang_Prod      = sum(kolom2_7_tabel5_2$Barang_Prod, na.rm = TRUE),
  Listrik_Prod     = sum(kolom2_7_tabel5_2$Listrik_Prod, na.rm = TRUE),
  Jasa_Prod        = sum(kolom2_7_tabel5_2$Jasa_Prod, na.rm = TRUE),
  Selisih_Stok     = sum(kolom2_7_tabel5_2$Selisih_Stok, na.rm = TRUE),
  Output_Lain      = sum(kolom2_7_tabel5_2$Output_Lain, na.rm = TRUE),
  Total_Output     = sum(kolom2_7_tabel5_2$Total_Output, na.rm = TRUE))

# TAMBAHKAN BARIS BARU KE TABEL 5.2
tabel5_2_prov = rbind(kolom2_7_tabel5_2, total_row_tabel5_2)

# SEPARATOR RIBUAN
tabel5_2_prov <- tabel5_2_prov |> 
  mutate(
    across(
      .cols = c(Barang_Prod, Listrik_Prod, Jasa_Prod, 
                Selisih_Stok, Output_Lain, Total_Output), 
      .fns = ~ format(round(., 0), big.mark = ".", decimal.mark = ",", scientific = FALSE)
    )
  )

## MATCH KODE & NAMA PROV
tabel5_2_prov <- tabel5_2_prov |>
  left_join(masterprov, by = c("Provinsi" = "Kode_Prov")) |>      # MATCH NAMA DAN KODE PROV
  mutate(
    Nama_Prov = if_else(is.na(Nama_Prov), Provinsi, Nama_Prov)    
  ) |>
  select(-1) |>                                                   # REORDER POSISI VAR
  select(ncol(tabel5_2_prov), everything()) |>
  rename(Provinsi = Nama_Prov)

## TABULASI
kable(tabel5_2_prov, align = "r")

```

## Tabel 6.2 Nilai Tambah menurut Provinsi, 2023

::: callout-note
**Biaya input** diambil dari penjumlahan nilai bahan baku dan penolong, nilai bahan bakar pelumas, pengeluaran listrik, pengeluaran sewa gedung mesin dan alat, nilai jasa industri yang dibayarkan ke pihak lain, pengeluaran air, dan pengeluaran lainnya.
**Nilai output** diambil dari penjumlahan nilai barang yang diproduksi, pendapatan jasa industri, nilai untung/rugi dari penjualan barang yang sama, penjualan kekayaan intelektual, pendapatan jasa yang tidak berkaitan dengan produksi, nilai listrik yang dijual, pendapatan lainnya, dan selisih stok barang setengah jadi (des minus jan).
**Nilai tambah harga pasar** adalah nilai output dikurangi biaya input.
**Pajak tak langsung** diambil dari variabel *r306 Pajak*.
**Nilai tambah** adalah nilai tambah harga pasar dikurangi nilai pajak.
:::

```{r tabel 6.2}
## KOLOM 2-6 NILAI TAMBAH
kolom2_6_tabel6_2 <- stpim23 |>
  group_by(prov) |>                 
  summarise(
    Total_Input         = sum((r501k5_sum + r303a + r304c + r305a + r311 + r312 + r313) * weight, na.rm = TRUE),
    Total_Output        = sum((r503k6_sum + r403a + r404a + r404b + r404c + r404d + r404f + (r406b - r406a)) * weight, na.rm = TRUE),
    Nilai_Tambah_psr    = Total_Output - Total_Input,
    Pajak               = sum(r306 * weight, na.rm = TRUE),
    Nilai_Tambah        = Nilai_Tambah_psr - Pajak) |>
    rename(Provinsi = prov)
    
# BUAT BARIS TOTAL BARU
total_row_tabel6_2 <- data.frame(
  Provinsi = "Indonesia",
  Total_Input       = sum(kolom2_6_tabel6_2$Total_Input, na.rm = TRUE),
  Total_Output      = sum(kolom2_6_tabel6_2$Total_Output, na.rm = TRUE),
  Nilai_Tambah_psr  = sum(kolom2_6_tabel6_2$Nilai_Tambah_psr, na.rm = TRUE),
  Pajak             = sum(kolom2_6_tabel6_2$Pajak, na.rm = TRUE),
  Nilai_Tambah      = sum(kolom2_6_tabel6_2$Nilai_Tambah, na.rm = TRUE))

# TAMBAHKAN BARIS BARU KE TABEL 5.2
tabel6_2_prov = rbind(kolom2_6_tabel6_2, total_row_tabel6_2)

# SEPARATOR RIBUAN
tabel6_2_prov <- tabel6_2_prov |> 
  mutate(
    across(
      .cols = c(Total_Input, Total_Output, Nilai_Tambah_psr, 
                Pajak, Nilai_Tambah), 
      .fns = ~ format(round(., 0), big.mark = ".", decimal.mark = ",", scientific = FALSE)
    )
  )

## MATCH KODE & NAMA PROV
tabel6_2_prov <- tabel6_2_prov |>
  left_join(masterprov, by = c("Provinsi" = "Kode_Prov")) |>      # MATCH NAMA DAN KODE PROV
  mutate(
    Nama_Prov = if_else(is.na(Nama_Prov), Provinsi, Nama_Prov)    
  ) |>
  select(-1) |>                                                   # REORDER POSISI VAR
  select(ncol(tabel6_2_prov), everything()) |>
  rename(Provinsi = Nama_Prov)

## TABULASI
kable(tabel6_2_prov, align = "r")

```

## Export ke Excel

```{r export tabel kbli ke excel}
#wb = createWorkbook()
wb <- loadWorkbook("Rantab STPIM.xlsx")  # ambil dari file excel hasil running tabel_ibs23

addWorksheet(wb, "Tabel 1.2")
writeData(wb, "Tabel 1.2", "Tabel 1.2 Jumlah Perusahaan dan Banyaknya Pekerja menurut Provinsi, 2023", startRow = 1, startCol = 1)
writeData(wb, "Tabel 1.2", tabel1_2_prov, startRow = 3, startCol = 1)

addWorksheet(wb, "Tabel 2.2")
writeData(wb, "Tabel 2.2", "Tabel 2.2 Jumlah Perusahaan dan Jenis Tenaga Kerja menurut Provinsi, 2023", startRow = 1, startCol = 1)
writeData(wb, "Tabel 2.2", tabel2_2_prov, startRow = 3, startCol = 1)

addWorksheet(wb, "Tabel 3.2")
writeData(wb, "Tabel 3.2", "Tabel 3.2 Pengeluaran untuk Pekerja menurut Provinsi dan Jenis Pengeluaran, 2023", startRow = 1, startCol = 1)
writeData(wb, "Tabel 3.2", tabel3_2_prov, startRow = 3, startCol = 1)

addWorksheet(wb, "Tabel 4.2")
writeData(wb, "Tabel 4.2", "Tabel 4.2 Biaya Input menurut Provinsi, 2023", startRow = 1, startCol = 1)
writeData(wb, "Tabel 4.2", tabel4_2_prov, startRow = 3, startCol = 1)

addWorksheet(wb, "Tabel 5.2")
writeData(wb, "Tabel 5.2", "Tabel 5.2 Nilai Output menurut Provinsi, 2023", startRow = 1, startCol = 1)
writeData(wb, "Tabel 5.2", tabel5_2_prov, startRow = 3, startCol = 1)

addWorksheet(wb, "Tabel 6.2")
writeData(wb, "Tabel 6.2", "Tabel 6.2 Nilai Tambah menurut Provinsi, 2023", startRow = 1, startCol = 1)
writeData(wb, "Tabel 6.2", tabel6_2_prov, startRow = 3, startCol = 1)

# Menyimpan workbook ke file Excel
saveWorkbook(wb, "Rantab STPIM.xlsx", overwrite = TRUE)
```